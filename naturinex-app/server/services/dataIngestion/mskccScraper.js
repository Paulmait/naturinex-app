const axios = require('axios');const cheerio = require('cheerio');const { GoogleGenerativeAI } = require('@google/generative-ai');const NaturalRemedy = require('../../models/naturalRemedySchema');// Initialize Gemini AIconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);const model = genAI.getGenerativeModel({ model: "gemini-pro" });class MSKCCScraper {  constructor() {    // Memorial Sloan Kettering Cancer Center herb database    this.baseUrl = 'https://www.mskcc.org/cancer-care/integrative-medicine/herbs';    this.herbs = [];  }  /**   * Scrape MSKCC herb database for cancer-related information   */  async scrapeHerbDatabase(herbs) {    const results = [];    for (const herb of herbs) {      try {        // Get MSKCC data        const mskccData = await this.getMSKCCData(herb);        // Process with AI for comprehensive analysis        const aiAnalysis = await this.analyzeWithAI(herb, mskccData);        // Create structured data with cancer-specific information        const remedyData = {          name: herb,          scientificName: aiAnalysis.scientificName || herb,          commonNames: aiAnalysis.commonNames || [],          category: 'herb',          dataSources: [{            name: 'MSKCC',            sourceId: `MSKCC-${herb.replace(/\s+/g, '-').toLowerCase()}`,            url: `${this.baseUrl}/${herb.replace(/\s+/g, '-').toLowerCase()}`,            lastUpdated: new Date(),            reliability: 95 // MSKCC is highly reliable for cancer-related info          }],          conditions: this.mergeCancerConditions(aiAnalysis.conditions || []),          safety: {            generalSafety: aiAnalysis.safety || 'caution',            sideEffects: aiAnalysis.sideEffects || [],            contraindications: this.addCancerContraindications(aiAnalysis.contraindications || []),            pregnancySafety: aiAnalysis.pregnancySafety || 'unknown',            lactationSafety: aiAnalysis.lactationSafety || 'unknown'          },          interactions: {            medications: this.addChemotherapyInteractions(aiAnalysis.drugInteractions || []),            supplements: aiAnalysis.supplementInteractions || [],            conditions: this.addCancerConditionInteractions(aiAnalysis.conditionInteractions || [])          },          dosage: aiAnalysis.dosage || {},          activeCompounds: aiAnalysis.activeCompounds || [],          mechanism: aiAnalysis.mechanism || '',          qualityScore: this.calculateQualityScore(aiAnalysis),          reviewedBy: 'AI',          status: 'active'        };        results.push(remedyData);        // Rate limiting        await this.delay(1000);      } catch (error) {        console.error(`Error scraping MSKCC data for ${herb}:`, error.message);      }    }    return results;  }  /**   * Get MSKCC data (simulated - in production, would scrape actual MSKCC pages)   */  async getMSKCCData(herb) {    // Known MSKCC-reviewed herbs with cancer relevance    const mskccHerbs = {      'green tea': {        cancerUse: 'Prevention, adjuvant therapy',        warnings: 'May interfere with certain chemotherapy drugs',        evidence: 'Some evidence for prevention, limited for treatment'      },      'turmeric': {        cancerUse: 'Anti-inflammatory, potential anti-cancer properties',        warnings: 'May increase bleeding risk with anticoagulants',        evidence: 'Preclinical evidence strong, human studies ongoing'      },      'ginger': {        cancerUse: 'Chemotherapy-induced nausea',        warnings: 'Generally safe, may increase bleeding risk',        evidence: 'Good evidence for nausea relief'      },      'milk thistle': {        cancerUse: 'Liver protection during chemotherapy',        warnings: 'May affect drug metabolism',        evidence: 'Mixed evidence, more research needed'      },      'astragalus': {        cancerUse: 'Immune support during treatment',        warnings: 'May stimulate immune system',        evidence: 'Some positive studies in combination with conventional treatment'      }    };    return mskccHerbs[herb.toLowerCase()] || { cancerUse: 'Not reviewed by MSKCC' };  }  /**   * Analyze herb with AI using MSKCC cancer care standards   */  async analyzeWithAI(herb, mskccData) {    try {      const prompt = `        Analyze this herb for cancer patients according to MSKCC Integrative Medicine standards:        Herb: ${herb}        MSKCC Cancer Use: ${mskccData.cancerUse || 'Not specified'}        MSKCC Warnings: ${mskccData.warnings || 'None listed'}        Evidence Level: ${mskccData.evidence || 'Not specified'}        Provide analysis specific to cancer care:        1. Scientific name and common names        2. Conditions (especially cancer-related) with evidence        3. Safety for cancer patients (very important)        4. Side effects relevant to cancer patients        5. Interactions with chemotherapy and cancer medications        6. Contraindications for cancer patients        7. Effects on cancer treatment outcomes        8. Dosage for cancer patients (if applicable)        9. Active compounds with anti-cancer properties        10. Mechanism of action in cancer context        Be extremely cautious and conservative with recommendations for cancer patients.        Format as JSON:        {          "scientificName": "",          "commonNames": [],          "conditions": [{"name": "", "effectiveness": "", "evidence": {"studies": 0, "quality": ""}}],          "safety": "",          "sideEffects": [{"effect": "", "frequency": "", "severity": ""}],          "drugInteractions": [{"name": "", "severity": "", "description": ""}],          "supplementInteractions": [{"name": "", "severity": "", "description": ""}],          "contraindications": [],          "pregnancySafety": "",          "lactationSafety": "",          "dosage": {            "adult": {"typical": "", "max": "", "unit": "", "frequency": ""},            "cancerPatient": {"typical": "", "max": "", "unit": "", "frequency": "", "notes": ""}          },          "activeCompounds": [],          "mechanism": "",          "conditionInteractions": [{"condition": "", "concern": ""}],          "cancerSpecific": {            "immuneEffects": "",            "chemotherapyInterference": "",            "radiationInterference": "",            "tumorGrowthEffects": ""          }        }      `;      const result = await model.generateContent(prompt);      const response = await result.response;      const text = response.text();      // Extract JSON from response      const jsonMatch = text.match(/\{[\s\S]*\}/);      if (jsonMatch) {        return JSON.parse(jsonMatch[0]);      }      return {};    } catch (error) {      console.error('AI analysis error:', error.message);      return {};    }  }  /**   * Merge cancer-specific conditions   */  mergeCancerConditions(conditions) {    const cancerConditions = [      'cancer prevention',      'chemotherapy side effects',      'radiation side effects',      'cancer-related fatigue',      'cancer pain'    ];    // Add cancer-specific conditions if not already present    const existingNames = conditions.map(c => c.name.toLowerCase());    cancerConditions.forEach(condition => {      if (!existingNames.includes(condition)) {        conditions.push({          name: condition,          effectiveness: 'possible',          evidence: {            studies: 0,            quality: 'low'          }        });      }    });    return conditions;  }  /**   * Add cancer-specific contraindications   */  addCancerContraindications(contraindications) {    const cancerContraindications = [      'Active chemotherapy without oncologist approval',      'Immunosuppressed patients',      'Before surgery (may affect bleeding)',      'With radiation therapy (consult oncologist)'    ];    return [...new Set([...contraindications, ...cancerContraindications])];  }  /**   * Add chemotherapy drug interactions   */  addChemotherapyInteractions(interactions) {    const chemoInteractions = [      {        name: 'Chemotherapy drugs (general)',        severity: 'major',        description: 'May affect drug metabolism or effectiveness. Always consult oncologist.'      },      {        name: 'Immunotherapy drugs',        severity: 'major',        description: 'May interfere with immune system modulation.'      }    ];    return [...interactions, ...chemoInteractions];  }  /**   * Add cancer condition interactions   */  addCancerConditionInteractions(interactions) {    const cancerInteractions = [      {        condition: 'Active cancer treatment',        concern: 'May interfere with treatment effectiveness or increase side effects'      },      {        condition: 'Immune system cancers',        concern: 'May affect immune response unpredictably'      },      {        condition: 'Hormone-sensitive cancers',        concern: 'May have hormonal effects'      }    ];    return [...interactions, ...cancerInteractions];  }  /**   * Calculate quality score for cancer information   */  calculateQualityScore(aiAnalysis) {    let score = 70; // Base score for MSKCC data    // Add points for cancer-specific information    if (aiAnalysis.cancerSpecific) score += 15;    if (aiAnalysis.conditions?.some(c => c.name.includes('cancer'))) score += 10;    if (aiAnalysis.drugInteractions?.length > 0) score += 5;    return Math.min(score, 100);  }  /**   * Delay helper for rate limiting   */  delay(ms) {    return new Promise(resolve => setTimeout(resolve, ms));  }}module.exports = MSKCCScraper;